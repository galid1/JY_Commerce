<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:replace="fragments/configHeader"/>
<body>
<div th:replace="fragments/head"/>

<div class="container">
    <div class="titleContainer">
        <h2>
            주문목록/배송조회
        </h2>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>주문번호</th>
                <th>주문일자</th>
                <th>주문상품정보</th>
                <th>결제금액</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="myOrder : ${myOrderSummary.myOrderList}">
                <td th:text="${myOrder.orderId}"></td>
                <td th:text="${#temporals.format(myOrder.orderDate, 'yyyy-MM-dd HH:mm')}"></td>
                <td>
                    <a class="itemInformationContainer" th:href="@{/my/orders/{orderId}(orderId=${myOrder.orderId})}">
                        <img class="representativeImage" th:src="@{${myOrder.getRepresentativeImagePath()}}">
                        <span class="representativeName" th:text="${myOrder.getRepresentativeItemName() + ' 등'}"></span>
                    </a>
                </td>
                <td th:text="${myOrder.getTotalAmount()}"></td>
            </tr>
        </tbody>
        <div id="myOrderTotalCount" style="display: none;" th:text="${myOrderSummary.total}"></div>
    </table>

</div>

</body>
</html>

<style>
    .titleContainer {
        height: 10vh;
        display: flex;
        align-items: center;
    }

    td {
        font-size: 13px;
    }

    .itemInformationContainer {
        display: flex;
        max-width: 620px;
        min-width: 620px;
    }

    .representativeImage {
        max-width: 60px;
        min-width: 60px;
        max-height: 60px;
        min-width: 60px;
        margin-right: 20px;
    }

    .representativeName {
        color: black;
    }
</style>

<script>
    $(function() {
      const size = 20;
      let total = parseInt($("#myOrderTotalCount").text());

      if($(window).scrollTop() + $(window).height() == $(document).height()) {
        loadMoreOrderList();
      }
      else {
        $(window).scroll(function() {
          if($(window).scrollTop() + $(window).height() == $(document).height()) {
            loadMoreOrderList();
          }
        });
      }

      async function loadMoreOrderList() {
        let nextPage = parseInt(total/size);
        let data = '';
        console.log('total : ' + total);
        await $.get(`/api/my/orders?page=${nextPage}&size=${size}`, function(result) {
          data = result;
        })
        $("tbody").append(toTrList(data.myOrderList));
        total += data.total;
      }

      function toTrList(orderList) {
        let trList = "";

        orderList.forEach(order => {
          trList +=
            "<tr>" +
                `<td>${order.orderId}</td>` +
                `<td>${order.orderDate}</td>` +
                "<td>" +
                    "<a class='itemInformationContainer' href='/my/orders/" + order.orderId + "'></a>" +
                        "<img class='representativeImage' src='" + order.representativeImagePath + "'>" +
                            "<span class='representativeName'>" + order.representativeItemName + " </span>" +
                "</td>" +
                "<td>" + order.totalAmount + "</td>" +
            "</tr>";
        });

        return trList;
      }
    });
</script>